"use strict";angular.module("KinoaApp",["ngRoute","ngGrid","ngCookies","dpd","underscore","ui.bootstrap","pascalprecht.translate","angularFileUpload"]).config(["$routeProvider",function(e){e.when("/",{templateUrl:"app/pages/main/main.html",controller:"MainCtrl",auth:!0}).when("/societes/",{templateUrl:"app/pages/companyList/companyList.html",controller:"CompanyListCtrl",auth:!0,requireAdmin:!0}).when("/societes/new",{templateUrl:"app/pages/companyPage/companyPage.html",controller:"NewCompanyCtrl",auth:!0}).when("/societes/:societeId",{templateUrl:"app/pages/companyPage/companyPage.html",controller:"CompanyDetailsCtrl",auth:!0}).when("/contacts/new",{templateUrl:"app/pages/contactPage/detailsContact.html",controller:"NewContactCtrl",auth:!0}).when("/contacts/:contactId",{templateUrl:"app/pages/contactPage/detailsContact.html",controller:"DetailsContactCtrl",auth:!0}).when("/centreimpots/new",{templateUrl:"app/pages/taxePage/detailsTaxes.html",controller:"NewTaxeCtrl",auth:!0}).when("/centreimpots/:taxesId",{templateUrl:"app/pages/taxePage/detailsTaxes.html",controller:"DetailsTaxesCtrl",auth:!0}).when("/login",{templateUrl:"app/pages/login/login.html",controller:"LoginCtrl"}).when("/logout",{templateUrl:"app/pages/logout/logout.html",controller:"LogoutCtrl"}).when("/suivi",{templateUrl:"app/pages/followup/followup.html",controller:"FollowupCtrl",auth:!0}).when("/aide",{templateUrl:"app/pages/help/help.html",controller:"HelpCtrl"}).otherwise({redirectTo:"/"})}]).config(["$provide",function(e){e.decorator("$exceptionHandler",function(e,n){return function(o,a){e(o,a),alert("Une erreur vient de se produire, merci de noter la date et l'heure et d'envoyer un message à Nicolas."),console.log("Exception: ",o);var t=new XMLHttpRequest;t.open("POST","/errors",!0),t.setRequestHeader("Content-type","application/x-www-form-urlencoded"),t.onload=function(){console.log(this.responseText)},t.send("message="+o.message+"&cause="+a+"&exception="+o+"&errorUrl="+n.location.href+"&creationDate="+(new Date).getTime())}})}]).run(["$rootScope","$location","AuthService",function(e,n,o){e.$on("$routeChangeStart",function(e,a){var t="/login";a.auth&&!o.isLogged()&&n.path(t),a.requireAdmin&&!o.isAdmin()&&n.path("/")})}]).value("dpdConfig",["companies","todos","contacts","companytocontact","taxes","companytotaxe","users","companytouser","upload"]),angular.module("KinoaApp").config(["$translateProvider",function(e){e.translations("en",{"menu.help":"Help","menu.followup":"Follow-up","menu.add":"Add","menu.logout":"Logout","menu.login":"Login","menu.french":"French","menu.english":"English","menu.german":"German","login.message":"Please enter your credentials","login.email.placeholder":"Your email","login.password.placeholder":"Your password","login.submit.button":"Login"}).translations("fr",{"menu.help":"Aide","menu.followup":"Suivi","menu.add":"Ajouter","menu.logout":"Déconnexion","menu.login":"Connexion","menu.french":"Francais","menu.english":"Anglais","menu.german":"Allemand","login.message":"Merci de vous connecter","login.email.placeholder":"Votre email","login.password.placeholder":"Votre mot de passe","login.submit.button":"Connexion"}),e.preferredLanguage("en")}]),angular.module("KinoaApp").controller("CompanyListCtrl",["$scope","$log","dpd","CountryService","AuthService","CompaniesService","EnumService","$modal","_","$location",function(e,n,o,a,t,i,r,s){e.filter={},e.companyStatusList=r.companyStatus,e.companyStatusListFilter=angular.copy(e.companyStatusList);var c={french:"Tous"};e.companyStatusListFilter.unshift(c),e.filter.status=c,e.search=function(o){n.log(o),e.loading="Chargement en cours, merci de patienter...";var a=u(o);i.getAllCompanies(a).then(function(n){e.companyList=n,delete e.loading})};var u=function(e){var n={includeCompanytouser:!0,$limit:500};return e.status&&(n.status=e.status.id),e.name&&(n.name={$regex:e.name,$options:"i"}),n};o.users.get(function(n){e.users=n}),e.changeCompanyStatus=function(a,t){n.log(a,t),o.companies.put(a,{status:t},function(o,t){if(400>t){var i="Statut de l'entreprise '"+o.name+"' mise à jour.";n.log(i),e.info=i}else{var r="Erreur lors de de la mise à jour du statut de "+a;n.error(r),e.error=r}})},e.deleteCompany=function(o){n.log(o);var a=prompt("Vous vous appretez à supprimer l'entreprise \n\n'"+o.name+"'\n\nPour confirmer votre choix, merci de taper le nom de l'entreprise dans ce champ: ");a.toLowerCase()===o.name.toLowerCase()&&!function(o){i.deleteCompany(o.id).then(function(){var a="L'entreprise '"+o.name+"' a été corectement supprimé.";n.log(a),e.info=a;var t=e.companyList.indexOf(o);e.companyList.splice(t,1)},function(){var a="Erreur lors de de la suppression "+o.name;throw n.error(a),e.error=a,a})}(o)},e.batchStatusUpdate=function(o,a){n.log(o.status.id);for(var t in a){var r=a[t];n.log(r),i.updateCompany({id:r.id,status:o.status.id}).then(function(){var n="Les entreprises  ont été correctement mises à jour.";e.info=n,e.search(e.filter)})}},e.batchRightsUpdate=function(n,o){if("undefined"==typeof o&&(e.error="La liste est vide !"),o.length>499)return e.error="Vous avez trop de résultats, merci de filtrer.",void 0;for(var a in n){var t=n[a];if("undefined"!=typeof t.companytouser)for(var r in o){var s=o[r];!function(n,o){i.getCompanyToUser(o,n).then(function(a){if(a.length>0){var t=a[0];t.rightsLevel=o.companytouser.rightsLevel,i.updateCompanytouser(t).then(function(){var n="Les entreprises ont été correctement mises à jour.";e.info=n,e.search(e.filter)})}else{var t={rightsLevel:o.companytouser.rightsLevel,companyId:n.id,userId:o.id};i.createCompanytouser(t).then(function(){var n="Les entreprises ont été correctement mises à jour.";e.info=n,e.search(e.filter)})}})}(s,t)}}},e.gridOptions={data:"companyList",enablePinning:!1,columnDefs:[{field:"id",displayName:"Ouvrir",width:50,cellTemplate:"app/pages/companyList/companyList/companyListDisplay.html"},{field:"name",displayName:"Nom",width:400,pinned:!0},{field:"address1",displayName:"Adresse",width:120},{field:"postalCode",displayName:"Nom",width:80},{field:"city",width:120},{field:"country",width:40},{field:"website",width:120},{field:"phone",width:120},{field:"fax",width:120},{field:"id",displayName:"Droit d'accès",width:140,cellTemplate:'<button class="btn btn-default btn-sm" ng-click="openRightsModal(row.getProperty(col.field))">Modifier les droits</button>'},{field:"status",displayName:"Statut",width:200,cellTemplate:"app/pages/companyList/companyList/companyListStatusColumn.html"},{field:"id",displayName:"Suppression",width:150,cellTemplate:"app/pages/companyList/companyList/companyListDeleteColumn.html"}]},e.openRightsModal=function(a){n.log("Opening modal for companyId : ",a);for(var t in e.users)!function(e){o.companytouser.get({companyId:a,userId:e.id},function(n){e.companytouser=n[0]})}(e.users[t]);var i=s.open({templateUrl:"app/pages/companyList/companyList/companyListRightsModalContent.html",controller:l,resolve:{company:function(){for(var n in e.companyList)if(e.companyList[n].id===a)return e.companyList[n]},users:function(){return e.users}}});i.result.then(function(a){for(var t in a.users){var i=a.users[t],r=i.companytouser;if(r&&r.id)n.log("We are updating companytouser",r),o.companytouser.put(r.id,r,function(o,t){if(400>t){var i="Droits d'entreprise '"+a.name+"' mise à jour.";n.log(i),e.info=i}else{var r="Erreur pendant la mise à jour des droits de l'entreprise "+a.name;n.err(r),e.error(r)}});else{if(n.log("We are creating companytouser",r),"undefined"==typeof r)continue;r.companyId=a.id,r.userId=i.id,function(a,t){o.companytouser.post(t,function(o,t){if(400>t){n.log(o);var i="Droits d'entreprise '"+a.name+"' mise à jour.";n.log(i),e.info=i}else{var r="Erreur pendant la mise à jour des droits de l'entreprise "+a.name;n.err(r),e.error(r)}})}(a,r)}}},function(){n.info("Modal dismissed at: "+new Date)})};var l=function(e,n,o,a){e.company=o,e.company.users=a,e.ok=function(){n.close(e.company)},e.cancel=function(){n.dismiss("cancel")}}}]),angular.module("KinoaApp").controller("NewCompanyCtrl",["$scope","$location","$log","CountryService","AuthService","CompaniesService",function(e,n,o,a,t,i){e.creation=!0,e.societe={},e.countryList=a.findAll(),e.createCompany=function(e){var a=t.currentUser();o.log("Create a company: ",e),i.createCompany(e,a).then(function(e){n.path("/societes/"+e.companyId)})}}]),angular.module("KinoaApp").controller("CompanyDetailsCtrl",["$scope","$routeParams","$log","$http","dpd","CountryService","AuthService","ContactsService","_","CompaniesService","EnumService","$upload",function(e,n,o,a,t,i,r,s,c,u,l,m){e.loading="Chargement en cours, merci de patienter...",e._=c,e.anneeDepotReclam=2014,e.countryList=i.findAll(),e.companyStatusList=l.companyStatus,e.currentUser=r.currentUser(),e.civilities=l.civilities,e.unassociatedContacts=[];var d=n.societeId;e.canWrite=!1,r.isAdmin()?e.canWrite=!0:t.companytouser.get({companyId:d,userId:e.currentUser.id},function(n){o.log("companyToUser: ",n),n&&n[0].rightsLevel>1&&(e.canWrite=!0)}),u.getCompany(d,e.currentUser.id).then(function(n){o.log("Societe chargée: ",n),e.societe=n,n.status&&(e.societe.statusToDisplay=l.getCompanyStatus(n.status).french),delete e.loading},function(n){throw o.log(n),e.error=n,n}),t.todos.get({companyId:d,includeAssignedUser:!0,includeCreator:!0},function(n){e.todos=n}),t.users.get(function(n){e.users=n}),e.associatedContacts=[],t.companytocontact.get({companyId:d},function(n){for(var o in n){var a=n[o].contactId;s.getContact(a).then(function(n){e.associatedContacts.push(n)})}}),e.associatedTaxes=[],t.companytotaxe.get({companyId:d},function(n){for(var o in n)t.taxes.get({id:n[o].taxeId},function(n){e.associatedTaxes.push(n)})}),e.unassociatedTaxes=[],t.taxes.get(function(n){e.taxes=n,angular.copy(n,e.unassociatedTaxes),t.companytotaxe.get({companyId:d},function(n){for(var o in n)for(var a in e.unassociatedTaxes)e.unassociatedTaxes[a].id===n[o].taxeId&&e.unassociatedTaxes.splice(a,1)})}),e.searchUnassociatedContacts=function(n){var a={};if(n)var a={$or:[{lastname:{$regex:n,$options:"i"}},{firstname:{$regex:n,$options:"i"}},{company:{$regex:n,$options:"i"}}]};s.searchContacts(a).then(function(n){o.log(n),e.unassociatedContacts=n})},e.associateContact=function(n){o.log("Associate a contact: ",n),t.companytocontact.get({companyId:d,contactId:n.id},function(o){""==o&&t.companytocontact.post({companyId:d,contactId:n.id},function(){e.associatedContacts.push(n);var o=e.unassociatedContacts.indexOf(n);e.unassociatedContacts.splice(o,1)})})},e.desassociateContact=function(n){o.log("Desassociate a contact: ",n),t.companytocontact.get({companyId:d,contactId:n.id},function(o){t.companytocontact.del(o[0].id,function(){var o=e.associatedContacts.indexOf(n);e.associatedContacts.splice(o,1),e.unassociatedContacts.push(n)})})},e.createAssociateContact=function(n){o.log("Create and associate a contact: ",n),t.contacts.post(n,function(n){t.companytocontact.post({companyId:d,contactId:n.id},function(){e.associatedContacts.push(n);var o=e.unassociatedContacts.indexOf(n);e.unassociatedContacts.splice(o,1),e.newcontact={}})})},e.associateTaxe=function(n){o.log("Associate a taxe: ",n),t.companytotaxe.get({companyId:d,taxeId:n.id},function(o){o&&t.companytotaxe.post({companyId:d,taxeId:n.id},function(){e.associatedTaxes.push(n);var o=e.unassociatedTaxes.indexOf(n);e.unassociatedTaxes.splice(o,1)})})},e.desassociateTaxe=function(n){o.log("Desassociate a taxe: ",n),t.companytotaxe.get({companyId:d,taxeId:n.id},function(o){t.companytotaxe.del(o[0].id,function(){var o=e.associatedTaxes.indexOf(n);e.associatedTaxes.splice(o,1),e.unassociatedTaxes.push(n)})})},e.createAssociateTaxe=function(n){o.log("Create and associate a taxe: ",n),t.taxes.post(n,function(n){t.companytotaxe.post({companyId:d,taxeId:n.id},function(){e.associatedTaxes.push(n);var o=e.unassociatedTaxes.indexOf(n);e.unassociatedTaxes.splice(o,1)})})},e.updateCompany=function(n){o.log("Update a company: ",n),n.lastModification=(new Date).getTime(),u.updateCompany(n).then(function(n){var a="Fiche entreprise "+n.name+" mise à jour.";o.log(a),e.info=a,e.societe.statusToDisplay=l.getCompanyStatus(n.status).french})},e.changeCompanyVip=function(n,a){o.log("Changing VIP status",a),c.isEmpty(a.companytouser)?t.companytouser.post({companyId:a.id,userId:e.currentUser.id,vip:n,lastModification:(new Date).getTime()},function(n){e.societe.companytouser=n}):t.companytouser.put(a.companytouser.id,{lastModification:(new Date).getTime(),vip:n},function(n,a){if(400>a){var t="Fiche entreprise "+e.societe.name+" mise à jour.";o.log(t),e.info=t,e.societe.companytouser=n}else{var i="Erreur pendant la sauvegarde de l'entreprise "+e.societe.name;o.err(i),e.error(i)}})},e.addTodo=function(n){o.log("Create a todo: ",n),t.todos.post({companyId:d,message:n.message,status:"1",dueDate:n.dueDate.getTime(),assignedId:n.assignedId,creationDate:(new Date).getTime(),lastModification:(new Date).getTime()},function(a,t){if(t>=400){var i="Erreur lors de la création de la tache "+n.message;o.error(i),e.error=i}})},e.archiveTodo=function(n){n.status="0",n.lastModification=(new Date).getTime(),t.todos.put(n.id,n,function(a,t){if(400>t);else{var i="Erreur lors de l'archivage de la tache "+n.message;o.error(i),e.error=i}})},e.files=[],e.uploadedFiles=[],e.setFiles=function(n){e.$apply(function(e){e.files=[];for(var o=0;o<n.files.length;o++)e.files.push(n.files[o])})},e.uploadMultipleFiles=function(){e.loading="Envoi en cours, merci de patienter...";var n=new FormData;for(var t in e.files)n.append(e.files[t].name,e.files[t]);a({method:"POST",url:"/upload",data:n,params:{subdir:d,creator:e.currentUser},headers:{"Content-Type":void 0},transformRequest:angular.identity}).success(function(n,a){if(400>a){var t="Fichiers correctement uploadés!";delete e.loading,o.log(n),e.info=t,e.uploadedFiles=e.uploadedFiles.concat(n),angular.forEach(angular.element("input[type='file']"),function(e){angular.element(e).val(null)})}else{var i="Erreur pendant l'upload des fichiers "+e.files.join(", ");o.err(i),e.error(i)}})},e.onFileSelect=function(n){e.loading="Envoi en cours, merci de patienter...";for(var a=0;a<n.length;a++){var t=n[a];e.upload=m.upload({url:"/upload",params:{subdir:d,creator:e.currentUser.id},file:t}).progress(function(e){console.log("percent: "+parseInt(100*e.loaded/e.total))}).success(function(n){var a="Fichiers correctement uploadés!";delete e.loading,o.log(n),e.info=a,e.uploadedFiles=e.uploadedFiles.concat(n)})}},e.getUploadedFiles=function(){t.upload.get({subdir:d},function(n){e.uploadedFiles=n})},e.getUploadedFiles(),e.deleteUploadedFile=function(n){var a=confirm("Etes-vous sur de vouloir supprimer le fichier "+n.filename+" ?");a&&t.upload.del(n.id,function(a,t){if(400>t){e.info="Fichier "+n.filename+" correctement effacé";var i=e.uploadedFiles.indexOf(n);e.uploadedFiles.splice(i,1)}else{var r="Erreur lors de la suppression du fichier "+n.filename;o.err(r),e.error(r)}})}}]),angular.module("KinoaApp").controller("NewContactCtrl",["$scope","dpd","$location","$log","EnumService",function(e,n,o,a,t){e.creation=!0,e.civilities=t.civilities,e.createContact=function(e){a.log("Create a contact: ",e),n.contacts.post(e,function(e){o.path("/contacts/"+e.id)})}}]),angular.module("KinoaApp").controller("DetailsContactCtrl",["$scope","$routeParams","$log","dpd","AuthService","ContactsService","EnumService",function(e,n,o,a,t,i,r){var s=n.contactId;o.log(s),e.contact=null,i.getContact(s).then(function(n){e.contact=n}),e.civilities=r.civilities,e.associatedCompanies=[],a.companytocontact.get({contactId:s},function(n){for(var i in n)a.companies.get({id:n[i].companyId,includeCompanytouser:t.currentUser().id},function(n){o.log(n),e.associatedCompanies.push(n)})}),e.updateContact=function(n){o.log("Update a contact: ",n),n.lastModification=(new Date).getTime(),i.updateContact(n).then(function(n){var a="Fiche contact "+n.firstname+" "+n.lastname+" mise à jour.";o.log(a),e.info=a})}}]),angular.module("KinoaApp").controller("LoginCtrl",["$scope","$rootScope","$location","dpd","$http","AuthService","$log",function(e,n,o,a,t,i,r){e.login=function(){return e.user&&e.user.email&&e.user.passwd?(delete e.error,e.loading="Chargement en cours, merci de patienter",i.login({username:e.user.email,password:e.user.passwd},function(){o.path("/")},function(n){delete e.loading,r.log(n);var o="Probleme lors de votre connexion, merci de réessayer.";"undefined"==typeof n||null===n||""===n?o="Il semble y avoir un probleme avec le serveur. Si le problème persiste, merci de contacter Nicolas.":401===n.status&&(o="Votre identifiant ou mot de passe n'est pas correct, merci de réessayer."),e.error=o}),void 0):(e.error="Merci de remplir les champs email et mot de passe",void 0)}}]),angular.module("KinoaApp").controller("MainCtrl",["$scope","$rootScope","$log","dpd","$http","AuthService","_",function(e,n,o,a,t,i){e.user=i.currentUser(),e.currentDate=(new Date).getTime(),e.vipCompanies=[],a.companytouser.get({userId:e.user.id,vip:!0,includeCompany:!0,$limit:10,rightsLevel:{$gt:0}},function(n){e.vipCompanies=n}),e.todos=[],a.todos.get({assignedId:e.user.id,status:"1",$sort:{dueDate:1},includeCompany:!0,includeCompanytouser:e.user.id,includeAssignedUser:!0},function(n){e.todos=n})}]),angular.module("KinoaApp").controller("DetailsTaxesCtrl",["$scope","$routeParams","dpd","CountryService","AuthService","$log",function(e,n,o,a,t,i){e.countryList=a.findAll();var r=n.taxesId;e.taxe=null,o.taxes.get({id:r},function(n){e.taxe=n,console.log("Load taxe")}),e.updateTaxe=function(n){o.taxes.put(r,n,function(o,a){if(400>a){var t="Centre d'impôt "+o.name+" mise à jour.";i.log(t),e.info=t}else{var r="Erreur pendant la sauvegarde du centre d'impôt "+n.name;i.err(r),e.error(r)}})},e.associatedCompanies=[],o.companytotaxe.get({taxeId:r},function(n){for(var a in n)o.companies.get({id:n[a].companyId,includeCompanytouser:t.currentUser().id},function(n){i.log(n),e.associatedCompanies.push(n)})})}]),angular.module("KinoaApp").controller("NewTaxeCtrl",["$scope","dpd","$location","CountryService",function(e,n,o,a){e.countryList=a.findAll(),e.creation=!0,e.createTaxe=function(e){n.taxes.post(e,function(e){console.log(e.id),o.path("/centreimpots/"+e.id)})}}]),angular.module("KinoaApp").directive("scrollfollow",["$window",function(e){return{restrict:"A",link:function(n,o,a){var t,i,r,s,c,u,l;return l=angular.element(e),c=angular.element(o.parent()),t=o[0].getBoundingClientRect().top,s=n.$eval(a.scrollfollow)||5,i=function(){var e;return e=function(e){var n=e.match(/\d+/);return n&&n.length>0?n[0]:void 0},e(c.css("width"))-e(c.css("padding-left"))-e(c.css("padding-right"))},r=function(){var e;return e=$("#"+o.attr("id")).css("content"),"tablet"!==e&&l[0].scrollY>t?(o.addClass("scrollfollowing"),o.css({position:"fixed",top:s+"px",width:i()}),o.next().css({height:o[0].offsetHeight,display:"block"})):(o.removeClass("scrollfollowing"),o.css({position:"static",width:i()}),o.next().css({display:"none"}))},u=document.createElement("div"),u.className="scrollfollow_placeholder",u.style.display="none",o.after(u),r(),l.bind("scroll",function(){return r()}),l.bind("resize",function(){return o.css({width:i()})})}}}]),angular.module("KinoaApp").filter("temp",["$filter",function(e){return function(n,o){o||(o=1);var a=e("number");return a(n,o)+"°C"}}]).filter("capitalize",function(){return function(e){return e.substring(0,1).toUpperCase()+e.substring(1)}}).filter("characters",function(){return function(e,n,o){if(isNaN(n))return e;if(0>=n)return"";if(e&&e.length>=n){if(e=e.substring(0,n),o)for(;" "==e.charAt(e.length-1);)e=e.substr(0,e.length-1);else{var a=e.lastIndexOf(" ");-1!==a&&(e=e.substr(0,a))}return e+"..."}return e}}).filter("words",function(){return function(e,n){if(isNaN(n))return e;if(0>=n)return"";if(e){var o=e.split(/\s+/);o.length>n&&(e=o.slice(0,n).join(" ")+"...")}return e}}).filter("bytes",function(){return function(e,n){if(isNaN(parseFloat(e))||!isFinite(e))return"-";"undefined"==typeof n&&(n=1);var o=["bytes","kB","MB","GB","TB","PB"],a=Math.floor(Math.log(e)/Math.log(1024));return(e/Math.pow(1024,Math.floor(a))).toFixed(n)+" "+o[a]}}),angular.module("KinoaApp").factory("AuthService",["$http","$log","$cookieStore","_",function(e,n,o,a){var t=o.get("user"),i=function(a,i,r){n.log("AuthService.login()",a),e.post("/users/login",a).success(function(){e.get("/users/me").success(function(e){o.put("user",e),t=e,i(e)})}).error(r)},r=function(a,i){n.log("Logout"),e.post("/users/logout").success(function(e){o.remove("user"),t=null,a(e)}).error(function(e,n){i(n)})};return{login:i,isLogged:function(){return!a.isEmpty(t)},logout:r,currentUser:function(){return t},isAdmin:function(){return a.isEmpty(t)?!1:a.contains(t.roles,"admin")}}}]),angular.module("KinoaApp").factory("CompaniesService",["$http","$log","$q","_",function(e,n,o){var a="/companies/",t="/companytouser/",i=function(t){t="undefined"==typeof t?"{}":encodeURI(JSON.stringify(t));var i=o.defer();return n.log(t),e.get(a+"?"+t).success(function(e){i.resolve(e)}).error(function(){i.reject("Une erreur s'est produite en récupérant les societes.")}),i.promise},r=function(n,i){var r=o.defer();return e.get(a+n).success(function(o){if(i){var a=encodeURI(JSON.stringify({companyId:n,userId:i}));e.get(t+"?"+a).success(function(e){o.companytouser=e[0],r.resolve(o)})}else r.resolve(o)}).error(function(e,o){404===o?r.reject("La societe avec l'id "+n+" n'existe pas."):r.reject("Une erreur s'est produite en récupérant la societe.")}),r.promise},s=function(t){var i=o.defer();return e.put(a+t.id,t).success(function(e){n.log(e),i.resolve(e)}).error(function(){i.reject("Une erreur s'est produite en voulant mettre à jour la societe.")}),i.promise},c=function(n,i){var r=o.defer();return e.post(a,n).success(function(n){var o={companyId:n.id,userId:i.id,rightsLevel:2};e.post(t,o).success(function(e){r.resolve(e)}).error(function(){r.reject("Une erreur s'est produite en voulant ajouter la societe et son association.")})}).error(function(){r.reject("Une erreur s'est produite en voulant ajouter la societe.")}),r.promise},u=function(t){n.log(t);var i=o.defer();return e.delete(a+t).success(function(e){i.resolve(e)}).error(function(){i.reject("Une erreur s'est produite en voulant supprimer la societe.")}),i.promise},l=function(a,i){var r=o.defer();n.log(a,i);var s=encodeURI(JSON.stringify({companyId:i.id,userId:a.id}));return e.get(t+"?"+s).success(function(e){r.resolve(e)}).error(function(){r.reject("Une erreur s'est produite en récupérant la societe.")}),r.promise},m=function(n){var a=o.defer();return e.post(t,n).success(function(e){a.resolve(e)}).error(function(){a.reject("Une erreur s'est produite en voulant ajouter la companytouser.")}),a.promise},d=function(a){var i=o.defer();return n.log(a),e.put(t+a.id,a).success(function(e){i.resolve(e)}).error(function(){i.reject("Une erreur s'est produite en voulant mettre à jour la companytouser.")}),i.promise};return{getCompany:r,getAllCompanies:i,updateCompany:s,createCompany:c,deleteCompany:u,getCompanyToUser:l,createCompanytouser:m,updateCompanytouser:d}}]),angular.module("KinoaApp").factory("ContactsService",["$http","$log","$q","_","EnumService",function(e,n,o){var a="/contacts/",t=function(n){var t={cache:!0};"undefined"!=typeof n&&(t.params=n);var i=o.defer();return e.get(a,t).success(function(e){i.resolve(e)}).error(function(){i.reject("Une erreur s'est produite en récupérant les contacts.")}),i.promise},i=function(n){var t=o.defer(),i=encodeURI(JSON.stringify(n));return e.get(a+"?"+i).success(function(e){t.resolve(e)}).error(function(){t.reject("Une erreur s'est produite en récupérant les contacts.")}),t.promise},r=function(n){var t=o.defer();return e.get(a+n).success(function(e){"MADAME"===e.firstname||"MADAME"===e.prefixname||"Madame"===e.prefixname||"MME"===e.prefixname||"madame"===e.prefixname||"Mme"===e.prefixname?e.civility="madame":("MONSIEUR"===e.firstname||"MONSIEUR"===e.prefixname||"Monsieur"===e.prefixname||"monsieur"===e.prefixname||"M."===e.prefixname)&&(e.civility="monsieur"),t.resolve(e)}).error(function(){t.reject("Une erreur s'est produite en récupérant le contact.")}),t.promise},s=function(n){var t=o.defer();return e.put(a+n.id,n).success(function(e){t.resolve(e)}).error(function(){t.reject("Une erreur s'est produite en voulant mettre à jour le contact.")}),t.promise};return{getContact:r,getAllContacts:t,updateContact:s,searchContacts:i}}]),angular.module("KinoaApp").factory("CountryService",function(){var e=[{iso:"AF",name:"Afghanistan"},{iso:"ZA",name:"Afrique du Sud"},{iso:"AL",name:"Albanie"},{iso:"DZ",name:"Algérie"},{iso:"DE",name:"Allemagne"},{iso:"AD",name:"Andorre"},{iso:"AO",name:"Angola"},{iso:"AI",name:"Anguilla"},{iso:"AQ",name:"Antarctique"},{iso:"AG",name:"Antigua-et-Barbuda"},{iso:"AN",name:"Antilles néerlandaises"},{iso:"SA",name:"Arabie saoudite"},{iso:"AR",name:"Argentine"},{iso:"AM",name:"Arménie"},{iso:"AW",name:"Aruba"},{iso:"AU",name:"Australie"},{iso:"AT",name:"Autriche"},{iso:"AZ",name:"Azerbaïdjan"},{iso:"BS",name:"Bahamas"},{iso:"BH",name:"Bahreïn"},{iso:"BD",name:"Bangladesh"},{iso:"BB",name:"Barbade"},{iso:"BE",name:"Belgique"},{iso:"BZ",name:"Belize"},{iso:"BM",name:"Bermudes"},{iso:"BT",name:"Bhoutan"},{iso:"BO",name:"Bolivie"},{iso:"BA",name:"Bosnie-Herzégovine"},{iso:"BW",name:"Botswana"},{iso:"BN",name:"Brunéi Darussalam"},{iso:"BR",name:"Brésil"},{iso:"BG",name:"Bulgarie"},{iso:"BF",name:"Burkina Faso"},{iso:"BI",name:"Burundi"},{iso:"BY",name:"Bélarus"},{iso:"BJ",name:"Bénin"},{iso:"KH",name:"Cambodge"},{iso:"CM",name:"Cameroun"},{iso:"CA",name:"Canada"},{iso:"CV",name:"Cap-Vert"},{iso:"CL",name:"Chili"},{iso:"CN",name:"Chine"},{iso:"CY",name:"Chypre"},{iso:"CO",name:"Colombie"},{iso:"KM",name:"Comores"},{iso:"CG",name:"Congo"},{iso:"KP",name:"Corée du Nord"},{iso:"KR",name:"Corée du Sud"},{iso:"CR",name:"Costa Rica"},{iso:"HR",name:"Croatie"},{iso:"CU",name:"Cuba"},{iso:"CI",name:"Côte d’Ivoire"},{iso:"DK",name:"Danemark"},{iso:"DJ",name:"Djibouti"},{iso:"DM",name:"Dominique"},{iso:"SV",name:"El Salvador"},{iso:"ES",name:"Espagne"},{iso:"EE",name:"Estonie"},{iso:"FJ",name:"Fidji"},{iso:"FI",name:"Finlande"},{iso:"FR",name:"France"},{iso:"GA",name:"Gabon"},{iso:"GM",name:"Gambie"},{iso:"GH",name:"Ghana"},{iso:"GI",name:"Gibraltar"},{iso:"GD",name:"Grenade"},{iso:"GL",name:"Groenland"},{iso:"GR",name:"Grèce"},{iso:"GP",name:"Guadeloupe"},{iso:"GU",name:"Guam"},{iso:"GT",name:"Guatemala"},{iso:"GG",name:"Guernesey"},{iso:"GN",name:"Guinée"},{iso:"GQ",name:"Guinée équatoriale"},{iso:"GW",name:"Guinée-Bissau"},{iso:"GY",name:"Guyana"},{iso:"GF",name:"Guyane française"},{iso:"GE",name:"Géorgie"},{iso:"GS",name:"Géorgie du Sud et les îles Sandwich du Sud"},{iso:"HT",name:"Haïti"},{iso:"HN",name:"Honduras"},{iso:"HU",name:"Hongrie"},{iso:"IN",name:"Inde"},{iso:"ID",name:"Indonésie"},{iso:"IQ",name:"Irak"},{iso:"IR",name:"Iran"},{iso:"IE",name:"Irlande"},{iso:"IS",name:"Islande"},{iso:"IL",name:"Israël"},{iso:"IT",name:"Italie"},{iso:"JM",name:"Jamaïque"},{iso:"JP",name:"Japon"},{iso:"JE",name:"Jersey"},{iso:"JO",name:"Jordanie"},{iso:"KZ",name:"Kazakhstan"},{iso:"KE",name:"Kenya"},{iso:"KG",name:"Kirghizistan"},{iso:"KI",name:"Kiribati"},{iso:"KW",name:"Koweït"},{iso:"LA",name:"Laos"},{iso:"LS",name:"Lesotho"},{iso:"LV",name:"Lettonie"},{iso:"LB",name:"Liban"},{iso:"LY",name:"Libye"},{iso:"LR",name:"Libéria"},{iso:"LI",name:"Liechtenstein"},{iso:"LT",name:"Lituanie"},{iso:"LU",name:"Luxembourg"},{iso:"MK",name:"Macédoine"},{iso:"MG",name:"Madagascar"},{iso:"MY",name:"Malaisie"},{iso:"MW",name:"Malawi"},{iso:"MV",name:"Maldives"},{iso:"ML",name:"Mali"},{iso:"MT",name:"Malte"},{iso:"MA",name:"Maroc"},{iso:"MQ",name:"Martinique"},{iso:"MU",name:"Maurice"},{iso:"MR",name:"Mauritanie"},{iso:"YT",name:"Mayotte"},{iso:"MX",name:"Mexique"},{iso:"MD",name:"Moldavie"},{iso:"MC",name:"Monaco"},{iso:"MN",name:"Mongolie"},{iso:"MS",name:"Montserrat"},{iso:"ME",name:"Monténégro"},{iso:"MZ",name:"Mozambique"},{iso:"MM",name:"Myanmar"},{iso:"NA",name:"Namibie"},{iso:"NR",name:"Nauru"},{iso:"NI",name:"Nicaragua"},{iso:"NE",name:"Niger"},{iso:"NG",name:"Nigéria"},{iso:"NU",name:"Niue"},{iso:"NO",name:"Norvège"},{iso:"NC",name:"Nouvelle-Calédonie"},{iso:"NZ",name:"Nouvelle-Zélande"},{iso:"NP",name:"Népal"},{iso:"OM",name:"Oman"},{iso:"UG",name:"Ouganda"},{iso:"UZ",name:"Ouzbékistan"},{iso:"PK",name:"Pakistan"},{iso:"PW",name:"Palaos"},{iso:"PA",name:"Panama"},{iso:"PG",name:"Papouasie-Nouvelle-Guinée"},{iso:"PY",name:"Paraguay"},{iso:"NL",name:"Pays-Bas"},{iso:"PH",name:"Philippines"},{iso:"PN",name:"Pitcairn"},{iso:"PL",name:"Pologne"},{iso:"PF",name:"Polynésie française"},{iso:"PR",name:"Porto Rico"},{iso:"PT",name:"Portugal"},{iso:"PE",name:"Pérou"},{iso:"QA",name:"Qatar"},{iso:"HK",name:"R.A.S. chinoise de Hong Kong"},{iso:"MO",name:"R.A.S. chinoise de Macao"},{iso:"RO",name:"Roumanie"},{iso:"GB",name:"Royaume-Uni"},{iso:"RU",name:"Russie"},{iso:"RW",name:"Rwanda"},{iso:"CF",name:"République centrafricaine"},{iso:"DO",name:"République dominicaine"},{iso:"CD",name:"République démocratique du Congo"},{iso:"CZ",name:"République tchèque"},{iso:"RE",name:"Réunion"},{iso:"EH",name:"Sahara occidental"},{iso:"BL",name:"Saint-Barthélémy"},{iso:"KN",name:"Saint-Kitts-et-Nevis"},{iso:"SM",name:"Saint-Marin"},{iso:"MF",name:"Saint-Martin"},{iso:"PM",name:"Saint-Pierre-et-Miquelon"},{iso:"VC",name:"Saint-Vincent-et-les Grenadines"},{iso:"SH",name:"Sainte-Hélène"},{iso:"LC",name:"Sainte-Lucie"},{iso:"WS",name:"Samoa"},{iso:"AS",name:"Samoa américaines"},{iso:"ST",name:"Sao Tomé-et-Principe"},{iso:"RS",name:"Serbie"},{iso:"CS",name:"Serbie-et-Monténégro"},{iso:"SC",name:"Seychelles"},{iso:"SL",name:"Sierra Leone"},{iso:"SG",name:"Singapour"},{iso:"SK",name:"Slovaquie"},{iso:"SI",name:"Slovénie"},{iso:"SO",name:"Somalie"},{iso:"SD",name:"Soudan"},{iso:"LK",name:"Sri Lanka"},{iso:"CH",name:"Suisse"},{iso:"SR",name:"Suriname"},{iso:"SE",name:"Suède"},{iso:"SJ",name:"Svalbard et Île Jan Mayen"},{iso:"SZ",name:"Swaziland"},{iso:"SY",name:"Syrie"},{iso:"SN",name:"Sénégal"},{iso:"TJ",name:"Tadjikistan"},{iso:"TZ",name:"Tanzanie"},{iso:"TW",name:"Taïwan"},{iso:"TD",name:"Tchad"},{iso:"TF",name:"Terres australes françaises"},{iso:"IO",name:"Territoire britannique de l'océan Indien"},{iso:"PS",name:"Territoire palestinien"},{iso:"TH",name:"Thaïlande"},{iso:"TL",name:"Timor oriental"},{iso:"TG",name:"Togo"},{iso:"TK",name:"Tokelau"},{iso:"TO",name:"Tonga"},{iso:"TT",name:"Trinité-et-Tobago"},{iso:"TN",name:"Tunisie"},{iso:"TM",name:"Turkménistan"},{iso:"TR",name:"Turquie"},{iso:"TV",name:"Tuvalu"},{iso:"UA",name:"Ukraine"},{iso:"UY",name:"Uruguay"},{iso:"VU",name:"Vanuatu"},{iso:"VE",name:"Venezuela"},{iso:"VN",name:"Viêt Nam"},{iso:"WF",name:"Wallis-et-Futuna"},{iso:"YE",name:"Yémen"},{iso:"ZM",name:"Zambie"},{iso:"ZW",name:"Zimbabwe"},{iso:"ZZ",name:"région indéterminée"},{iso:"EG",name:"Égypte"},{iso:"AE",name:"Émirats arabes unis"},{iso:"EC",name:"Équateur"},{iso:"ER",name:"Érythrée"},{iso:"VA",name:"État de la Cité du Vatican"},{iso:"FM",name:"États fédérés de Micronésie"},{iso:"US",name:"États-Unis"},{iso:"ET",name:"Éthiopie"},{iso:"BV",name:"Île Bouvet"},{iso:"CX",name:"Île Christmas"},{iso:"NF",name:"Île Norfolk"},{iso:"IM",name:"Île de Man"},{iso:"KY",name:"Îles Caïmans"},{iso:"CC",name:"Îles Cocos - Keeling"},{iso:"CK",name:"Îles Cook"},{iso:"FO",name:"Îles Féroé"},{iso:"HM",name:"Îles Heard et MacDonald"},{iso:"FK",name:"Îles Malouines"},{iso:"MP",name:"Îles Mariannes du Nord"},{iso:"MH",name:"Îles Marshall"},{iso:"UM",name:"Îles Mineures Éloignées des États-Unis"},{iso:"SB",name:"Îles Salomon"},{iso:"TC",name:"Îles Turks et Caïques"},{iso:"VG",name:"Îles Vierges britanniques"},{iso:"VI",name:"Îles Vierges des États-Unis"},{iso:"AX",name:"Îles Åland"}];return{findAll:function(){return e},getNameFromIso:function(n){for(i=0;i<e.length;i++)if(e[i].iso===n)return e[i];return void 0}}}),angular.module("KinoaApp").factory("EnumService",["_",function(e){var n=[{id:0,name:"prospect",french:"prospect"},{id:1,name:"progress",french:"étude en cours"},{id:2,name:"dossier à reprendre ultérieurement",french:"dossier à reprendre ultérieurement"},{id:3,name:"dégrèvements obtenus",french:"dégrèvements obtenus"},{id:4,name:"rejet",french:"rejet"},{id:5,name:"réclamation envoyée",french:"réclamation envoyée"},{id:6,name:"refus commercial",french:"refus commercial"},{id:7,name:"dossier zéro",french:"dossier zéro"},{id:8,name:"stand by risqué",french:"stand by risqué"},{id:9,name:"archived",french:"archivé"},{id:10,name:"stand by taxes faibles",french:"stand by taxes faibles"},{id:11,name:"facture_etablie",french:"facture établie"},{id:12,name:"doublon autre client",french:"doublon autre client"}],o=function(o){return e.where(n,{id:o})[0]
},a=[{id:"madame",name:"Madame"},{id:"monsieur",name:"Monsieur"}];return{companyStatus:n,getCompanyStatus:o,civilities:a}}]),angular.module("KinoaApp").controller("HelpCtrl",function(){}),angular.module("KinoaApp").controller("LogoutCtrl",["$scope","$location","$log","AuthService",function(e,n,o,a){a.logout(function(){e.isLogged=!1,e.user=null,n.path("/login")},function(){o.error("Could not logout()")})}]),angular.module("KinoaApp").controller("FollowupCtrl",["$scope","dpd","$location","$log","CompaniesService",function(e,n,o,a,t){e.loading="Chargement en cours, merci de patienter...";var i={status:{$in:[1,5,11]},$limit:500};t.getAllCompanies(i).then(function(n){e.companyList=n,r(),delete e.loading});var r=function(){e.totalInvoiceAmount=0,e.totalInvoiceRestant=0,e.totalInvoicePaid=0;for(var n=e.companyList,o=0;o<n.length;o++){var a=n[o].invoiceAmount;a&&(e.totalInvoiceAmount+=parseFloat(a),n[o].invoicePaidOn?e.totalInvoicePaid+=parseFloat(a):e.totalInvoiceRestant+=parseFloat(a))}};e.updateCompany=function(n){a.log(n.invoicePaidOn),n.invoicePaidOn&&"[object Date]"===Object.prototype.toString.call(n.invoicePaidOn)&&(n.invoicePaidOn=n.invoicePaidOn.getTime()),n.cdifOn&&"[object Date]"===Object.prototype.toString.call(n.invoicePaidOn)&&(n.cdifOn=n.cdifOn.getTime()),n.comparOn&&"[object Date]"===Object.prototype.toString.call(n.invoicePaidOn)&&(n.comparOn=n.comparOn.getTime()),a.log(n),t.updateCompany(n).then(function(n){var o="Fiche entreprise "+n.name+" mise à jour.";r(),a.log(o),e.info=o})}}]),angular.module("KinoaApp").directive("ngFooter",function(){return{templateUrl:"app/shared/directives/footer/footer.html",restrict:"E"}}),angular.module("KinoaApp").directive("ngHeader",["AuthService","$location","$log","$translate",function(e,n,o,a){return{templateUrl:"app/shared/directives/header/header.html",restrict:"E",link:function(n){n.isLogged=e.isLogged(),n.user=e.currentUser(),n.isAdmin=e.isAdmin(),n.changeLanguage=function(e){a.use(e)}}}}]),angular.module("KinoaApp").directive("ngSidebar",["AuthService","dpd","$log","ContactsService","CompaniesService","$location",function(e,n,o,a,t,i){return{templateUrl:"app/shared/directives/sidebar/sidebar.html",restrict:"E",link:function(r,s,c){var u=$(document).height();$(".sidebarList").height(u-250);e.currentUser();r.resetSearchCompanies=function(){r.filtreCompanies=""},r.resetSearchCentres=function(){r.filtreCentres=""},r.searchContacts=function(e){var n={};if(e)var n={$or:[{lastname:{$regex:e,$options:"i"}},{firstname:{$regex:e,$options:"i"}},{company:{$regex:e,$options:"i"}}]};a.searchContacts(n).then(function(e){o.log(e),r.contactList=e})},r.searchCompanies=function(e){var n={$limit:500};e&&(n.name={$regex:e,$options:"i"}),t.getAllCompanies(n).then(function(e){o.log(e),1===e.length&&i.path("/societes/"+e[0].id),r.companyList=e})},n.taxes.get(function(e){r.listeTaxes=e}),r.activeTab=c.activetab,r.selectedItem=c.selecteditem}}}]);